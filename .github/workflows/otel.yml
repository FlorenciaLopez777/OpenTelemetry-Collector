name: OpenTelemetry E-Level (Dockerized Collector)

on:
  workflow_dispatch:
  push:
    paths:
      - 'otel_otlp.py'
      - 'otel-collector-config.yaml'
      - '.github/workflows/otel.yml'

jobs:
  run-otel:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install app dependencies
        run: |
          python -m pip install --upgrade pip
          pip install opentelemetry-api opentelemetry-sdk opentelemetry-exporter-otlp

      - name: Pull Collector image
        run: docker pull otel/opentelemetry-collector-contrib:latest

      - name: Start Collector (background)
        run: |
          docker rm -f otelcol || true
          docker run -d --name otelcol \
            -p 4317:4317 -p 4318:4318 \
            -v "$GITHUB_WORKSPACE/otel-collector-config.yaml":/etc/otelcol-contrib/config.yaml \
            otel/opentelemetry-collector-contrib:latest

      # Health-check robusto: acepta "Everything is ready" o "Starting GRPC server"
      - name: Wait for Collector health (up to 30s)
        shell: bash
        run: |
          for i in {1..30}; do
            docker logs otelcol --since 1s || true
            if docker logs otelcol 2>&1 | grep -qi "Everything is ready"; then
              echo "Collector ready."
              exit 0
            fi
            if docker logs otelcol 2>&1 | grep -qi "Starting GRPC server"; then
              echo "Collector GRPC server started."
              exit 0
            fi
            sleep 1
          done
          echo "Collector did not become ready in time."
          docker logs otelcol
          exit 1

      - name: Run Python app (send spans via OTLP)
        run: |
          python otel_otlp.py | tee app.log

      # Captura logs del collector con un pequeÃ±o margen temporal
      - name: Show Collector logs (capture output)
        run: |
          sleep 2
          docker logs otelcol --since 60s | tee collector_full.log

      # Opcional: si activaste el exporter "file" en el YAML, copia el JSON
      - name: Copy exported JSON (optional)
        if: always()
        run: |
          mkdir -p artifacts
          docker cp otelcol:/data/otel-traces.json ./artifacts/otel-traces.json 2>/dev/null || echo "No file exporter output found."
          cp -f app.log artifacts/app.log || true
          cp -f collector_full.log artifacts/collector_full.log || true

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: otel-results
          path: artifacts
          if-no-files-found: warn

      - name: Teardown
        if: always()
        run: docker rm -f otelcol || true
